#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
# export DH_VERBOSE=1

PKG=byobu
VER=`head -n 1 debian/changelog | sed 's/^.*(//' | sed 's/).*//' | sed 's/-.*//'`

get-orig-source:
	dh_testdir
	# bzr export needs a --exclude option for the following to work:
	#bzr export ../${PKG}_${VER}.orig.tar.gz
	# use tar instead
	mkdir -p ../tmp
	rm -rf ../tmp/*
	cp -a . ../tmp/${PKG}-${VER}
	tar -C ../tmp --exclude .bzr --exclude debian -zcvf ../${PKG}_${VER}.orig.tar.gz ${PKG}-${VER}
	rm -rf ../tmp
	ls -halF ../${PKG}_${VER}.orig.tar.gz

install-po: update-pot
	for po in po/*.po ; do \
		lang=$${po#po/}; lang=$${lang%.po}; \
		mkdir -p usr/share/locale/$${lang}/LC_MESSAGES/; \
		msgfmt $${po} -o usr/share/locale/$${lang}/LC_MESSAGES/${PKG}.mo ; \
	done

update-pot:
	rm -f po/${PKG}.pot
	xgettext -f po/POTFILES.Shell -o po/${PKG}.pot -L Shell
	xgettext -f po/POTFILES.Python -o po/${PKG}.pot -L Python -j
	for po in po/*.po ; do \
		msgmerge $${po} po/${PKG}.pot -o $${po} ; \
	done

prebuild:

build:

clean:
	dh_clean
	for po in po/*.po ; do \
		lang=$${po#po/}; lang=$${lang%.po}; \
		rm -f po/locale/$${lang}/LC_MESSAGES/${PKG}.mo ; \
	done

install: build install-po
	dh_testdir
	dh_testroot
	dh_clean -k
	# These links must be done in the postinst, as screen-profiles might not
	# be uninstalled yet
	#dh_link usr/bin/byobu-status usr/bin/screen-profiles-status
	#dh_link usr/bin/byobu-launcher usr/bin/screen-launcher
	dh_link usr/share/byobu/keybindings/f-keys usr/share/byobu/keybindings/common
	dh_link usr/bin/byobu usr/bin/byobu-launcher
	for i in black dark dark_blue dark_cyan dark_green dark_purple dark_red dark_yellow light light_blue light_cyan light_green light_purple light_red light_yellow; do dh_link usr/share/byobu/profiles/common usr/share/byobu/profiles/$${i}; done
	dh_install -X.bzr

# Everything else is handled by dh_install

# Build architecture-independent files here.
binary-indep: build install
	dh_testdir -i
	dh_testroot -i
	dh_installdocs -X.bzr -i
	dh_installman -i
	dh_installchangelogs -i
	dh_installdebconf -i
	dh_compress -i
	dh_fixperms -i
	dh_installdeb -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i

binary: binary-indep
.PHONY: build clean binary-indep binary install prebuild get-orig-source

binary-arch:
